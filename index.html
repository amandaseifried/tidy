<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Chore Tracker</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --green: #4caf50;
    --yellow: #ff9800;
    --red: #f44336;
    --bg: #f5f5f5;
    --card: #ffffff;
    --text: #212121;
    --text-secondary: #757575;
    --border: #e0e0e0;
    --fab-size: 56px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  html, body {
    height: 100%;
    overscroll-behavior: none;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }

  header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
    padding-top: calc(16px + env(safe-area-inset-top, 0px));
  }

  header h1 {
    font-size: 22px;
    font-weight: 700;
  }

  .empty-state {
    text-align: center;
    padding: 80px 32px;
    color: var(--text-secondary);
  }

  .empty-state p {
    font-size: 16px;
    margin-bottom: 8px;
  }

  .empty-state .hint {
    font-size: 14px;
  }

  #chore-list {
    padding: 8px 12px;
    padding-bottom: calc(80px + var(--safe-bottom));
  }

  .chore-card {
    background: var(--card);
    border-radius: 12px;
    margin-bottom: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    overflow: hidden;
    transition: box-shadow 0.2s;
  }

  .chore-row {
    display: flex;
    align-items: center;
    padding: 14px 16px;
    gap: 12px;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    min-height: 64px;
  }

  .chore-row:active {
    background: #f0f0f0;
  }

  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .status-dot.green { background: var(--green); }
  .status-dot.yellow { background: var(--yellow); }
  .status-dot.red { background: var(--red); }

  .chore-info {
    flex: 1;
    min-width: 0;
  }

  .chore-name {
    font-size: 16px;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .chore-meta {
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 2px;
  }

  .chore-meta .overdue {
    color: var(--red);
    font-weight: 500;
  }

  .done-btn {
    background: var(--green);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 18px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    flex-shrink: 0;
    min-height: 44px;
    min-width: 44px;
    -webkit-tap-highlight-color: transparent;
    transition: transform 0.15s, opacity 0.15s;
  }

  .done-btn:active {
    transform: scale(0.92);
    opacity: 0.8;
  }

  .done-btn.flash {
    animation: flash-done 0.4s ease;
  }

  @keyframes flash-done {
    0% { transform: scale(1); }
    30% { transform: scale(1.15); background: #66bb6a; }
    100% { transform: scale(1); }
  }

  /* Expanded detail section */
  .chore-detail {
    display: none;
    border-top: 1px solid var(--border);
    padding: 16px;
    background: #fafafa;
  }

  .chore-detail.open {
    display: block;
  }

  .detail-actions {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }

  .detail-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
    min-height: 44px;
    -webkit-tap-highlight-color: transparent;
  }

  .detail-btn.delete {
    color: var(--red);
    border-color: var(--red);
  }

  .detail-stats {
    margin-bottom: 12px;
  }

  .detail-stats p {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 4px;
  }

  .detail-stats strong {
    color: var(--text);
  }

  .history-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .history-list {
    list-style: none;
  }

  .history-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
  }

  .history-item:last-child {
    border-bottom: none;
  }

  .history-delete {
    background: none;
    border: none;
    color: var(--red);
    font-size: 18px;
    cursor: pointer;
    padding: 4px 8px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
  }

  .no-history {
    font-size: 14px;
    color: var(--text-secondary);
    font-style: italic;
  }

  /* FAB */
  .fab {
    position: fixed;
    bottom: calc(24px + var(--safe-bottom));
    right: 20px;
    width: var(--fab-size);
    height: var(--fab-size);
    border-radius: 50%;
    background: #1976d2;
    color: white;
    border: none;
    font-size: 28px;
    line-height: 1;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(25,118,210,0.4);
    z-index: 20;
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
    transition: transform 0.15s;
  }

  .fab:active {
    transform: scale(0.9);
  }

  /* Modal overlay */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 100;
    align-items: flex-end;
    justify-content: center;
  }

  .modal-overlay.open {
    display: flex;
  }

  .modal {
    background: var(--card);
    border-radius: 16px 16px 0 0;
    width: 100%;
    max-width: 500px;
    padding: 24px 20px;
    padding-bottom: calc(24px + var(--safe-bottom));
    animation: slide-up 0.25s ease;
  }

  @keyframes slide-up {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }

  .modal h2 {
    font-size: 20px;
    margin-bottom: 20px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 6px;
    color: var(--text-secondary);
  }

  .form-group input, .form-group select {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg);
    appearance: none;
    -webkit-appearance: none;
    min-height: 48px;
  }

  .form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: #1976d2;
    box-shadow: 0 0 0 2px rgba(25,118,210,0.2);
  }

  .freq-row {
    display: flex;
    gap: 10px;
  }

  .freq-row input {
    flex: 1;
  }

  .freq-row select, #chore-room-input {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23757575' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 32px;
  }

  .freq-row select {
    flex: 1.2;
  }

  .chore-room {
    font-size: 12px;
    color: var(--text-secondary);
    background: var(--bg);
    padding: 2px 8px;
    border-radius: 4px;
    display: inline-block;
    margin-top: 2px;
  }

  .modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 24px;
  }

  .modal-actions button {
    flex: 1;
    padding: 14px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    min-height: 48px;
    -webkit-tap-highlight-color: transparent;
  }

  .btn-cancel {
    background: var(--bg);
    color: var(--text);
  }

  .btn-save {
    background: #1976d2;
    color: white;
  }

  .btn-save:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Desktop tweaks */
  @media (min-width: 600px) {
    #chore-list {
      max-width: 540px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 100px;
    }

    header {
      text-align: center;
    }

    .modal {
      border-radius: 16px;
      margin-bottom: 40px;
    }

    .modal-overlay {
      align-items: center;
    }
  }
</style>
</head>
<body>

<header>
  <h1>Chore Tracker</h1>
</header>

<div id="chore-list"></div>

<button class="fab" id="fab-add" aria-label="Add chore">+</button>

<!-- Add/Edit Modal -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal">
    <h2 id="modal-title">Add Chore</h2>
    <div class="form-group">
      <label for="chore-name-input">Chore name</label>
      <input type="text" id="chore-name-input" placeholder="e.g. Vacuum living room" autocomplete="off">
    </div>
    <div class="form-group">
      <label for="chore-room-input">Room</label>
      <select id="chore-room-input">
        <option value="">Select a room</option>
        <option value="Bedroom">Bedroom</option>
        <option value="Bathroom">Bathroom</option>
        <option value="Living Room">Living Room</option>
        <option value="Kitchen">Kitchen</option>
        <option value="Patio">Patio</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="form-group">
      <label>Expected frequency</label>
      <div class="freq-row">
        <input type="number" id="freq-number" min="1" value="1" inputmode="numeric">
        <select id="freq-unit">
          <option value="1">days</option>
          <option value="7" selected>weeks</option>
          <option value="30">months</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="btn-cancel">Cancel</button>
      <button class="btn-save" id="btn-save">Save</button>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // --- Data layer ---
  const STORAGE_KEY = 'choreTracker';

  function loadChores() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      const data = JSON.parse(raw);
      return data.chores || [];
    } catch {
      return [];
    }
  }

  function saveChores(chores) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ chores }));
  }

  function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
  }

  // --- Time helpers ---
  function timeAgo(dateStr) {
    const diff = Date.now() - new Date(dateStr).getTime();
    const mins = Math.floor(diff / 60000);
    if (mins < 1) return 'just now';
    if (mins < 60) return mins + 'm ago';
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    const days = Math.floor(hrs / 24);
    if (days < 30) return days + 'd ago';
    const months = Math.floor(days / 30);
    return months + 'mo ago';
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }) +
      ' ' + d.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
  }

  function frequencyLabel(intervalDays) {
    if (intervalDays % 30 === 0 && intervalDays >= 30) {
      const m = intervalDays / 30;
      return 'every ' + m + (m === 1 ? ' month' : ' months');
    }
    if (intervalDays % 7 === 0 && intervalDays >= 7) {
      const w = intervalDays / 7;
      return 'every ' + w + (w === 1 ? ' week' : ' weeks');
    }
    return 'every ' + intervalDays + (intervalDays === 1 ? ' day' : ' days');
  }

  function overdueRatio(chore) {
    if (!chore.completions || chore.completions.length === 0) return Infinity;
    const last = new Date(chore.completions[0]).getTime();
    const elapsed = Date.now() - last;
    return elapsed / (chore.intervalDays * 86400000);
  }

  function statusColor(ratio) {
    if (ratio === Infinity || ratio > 1.0) return 'red';
    if (ratio >= 0.7) return 'yellow';
    return 'green';
  }

  function averageInterval(completions) {
    if (completions.length < 2) return null;
    const sorted = completions.map(c => new Date(c).getTime()).sort((a, b) => b - a);
    let total = 0;
    for (let i = 0; i < sorted.length - 1; i++) {
      total += sorted[i] - sorted[i + 1];
    }
    const avgMs = total / (sorted.length - 1);
    const days = avgMs / 86400000;
    if (days < 1) {
      const hrs = Math.round(avgMs / 3600000);
      return hrs + (hrs === 1 ? ' hour' : ' hours');
    }
    const rounded = Math.round(days * 10) / 10;
    return rounded + (rounded === 1 ? ' day' : ' days');
  }

  // --- State ---
  let chores = loadChores();
  let editingId = null;
  let expandedId = null;

  // --- DOM refs ---
  const listEl = document.getElementById('chore-list');
  const fabEl = document.getElementById('fab-add');
  const overlayEl = document.getElementById('modal-overlay');
  const modalTitleEl = document.getElementById('modal-title');
  const nameInput = document.getElementById('chore-name-input');
  const freqNumber = document.getElementById('freq-number');
  const freqUnit = document.getElementById('freq-unit');
  const roomInput = document.getElementById('chore-room-input');
  const btnCancel = document.getElementById('btn-cancel');
  const btnSave = document.getElementById('btn-save');

  // --- Render ---
  function render() {
    const sorted = [...chores].sort((a, b) => {
      const ra = overdueRatio(a);
      const rb = overdueRatio(b);
      if (ra === rb) return a.name.localeCompare(b.name);
      if (ra === Infinity) return -1;
      if (rb === Infinity) return 1;
      return rb - ra;
    });

    if (sorted.length === 0) {
      listEl.innerHTML = '<div class="empty-state"><p>No chores yet</p><p class="hint">Tap + to add your first chore</p></div>';
      return;
    }

    listEl.innerHTML = sorted.map(chore => {
      const ratio = overdueRatio(chore);
      const color = statusColor(ratio);
      const lastDone = chore.completions && chore.completions.length > 0
        ? timeAgo(chore.completions[0])
        : 'never';
      const freq = frequencyLabel(chore.intervalDays);
      const isOverdue = ratio > 1.0;
      const isExpanded = expandedId === chore.id;

      let detailHtml = '';
      if (isExpanded) {
        const avg = averageInterval(chore.completions || []);
        const completions = chore.completions || [];

        let historyHtml = '';
        if (completions.length === 0) {
          historyHtml = '<p class="no-history">No completions recorded</p>';
        } else {
          historyHtml = '<ul class="history-list">' + completions.map((c, i) =>
            '<li class="history-item">' +
              '<span>' + formatDate(c) + ' (' + timeAgo(c) + ')</span>' +
              '<button class="history-delete" data-chore-id="' + chore.id + '" data-index="' + i + '" aria-label="Delete entry">&times;</button>' +
            '</li>'
          ).join('') + '</ul>';
        }

        detailHtml = '<div class="chore-detail open">' +
          '<div class="detail-actions">' +
            '<button class="detail-btn" data-action="edit" data-id="' + chore.id + '">Edit</button>' +
            '<button class="detail-btn delete" data-action="delete-chore" data-id="' + chore.id + '">Delete</button>' +
          '</div>' +
          '<div class="detail-stats">' +
            (chore.room ? '<p>Room: <strong>' + escapeHtml(chore.room) + '</strong></p>' : '') +
            '<p>Expected: <strong>' + freq + '</strong></p>' +
            (avg ? '<p>Average interval: <strong>' + avg + '</strong></p>' : '') +
            '<p>Completions: <strong>' + completions.length + '</strong></p>' +
          '</div>' +
          '<p class="history-title">History</p>' +
          historyHtml +
        '</div>';
      }

      return '<div class="chore-card" data-id="' + chore.id + '">' +
        '<div class="chore-row" data-id="' + chore.id + '">' +
          '<div class="status-dot ' + color + '"></div>' +
          '<div class="chore-info">' +
            '<div class="chore-name">' + escapeHtml(chore.name) + '</div>' +
            '<div class="chore-meta">' +
              (isOverdue ? '<span class="overdue">overdue</span> &middot; ' : '') +
              'Last: ' + lastDone + ' &middot; ' + freq +
            '</div>' +
            (chore.room ? '<span class="chore-room">' + escapeHtml(chore.room) + '</span>' : '') +
          '</div>' +
          '<button class="done-btn" data-done-id="' + chore.id + '">Done</button>' +
        '</div>' +
        detailHtml +
      '</div>';
    }).join('');
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // --- Event handlers ---

  // Delegate clicks on the list
  listEl.addEventListener('click', function(e) {
    // Done button
    const doneBtn = e.target.closest('[data-done-id]');
    if (doneBtn) {
      e.stopPropagation();
      const id = doneBtn.dataset.doneId;
      markDone(id);
      doneBtn.classList.remove('flash');
      void doneBtn.offsetWidth; // reflow
      doneBtn.classList.add('flash');
      return;
    }

    // History delete
    const histDel = e.target.closest('.history-delete');
    if (histDel) {
      e.stopPropagation();
      const choreId = histDel.dataset.choreId;
      const index = parseInt(histDel.dataset.index, 10);
      deleteCompletion(choreId, index);
      return;
    }

    // Detail action buttons
    const actionBtn = e.target.closest('[data-action]');
    if (actionBtn) {
      e.stopPropagation();
      const action = actionBtn.dataset.action;
      const id = actionBtn.dataset.id;
      if (action === 'edit') {
        openEditModal(id);
      } else if (action === 'delete-chore') {
        if (confirm('Delete this chore?')) {
          deleteChore(id);
        }
      }
      return;
    }

    // Row tap â†’ expand/collapse
    const row = e.target.closest('.chore-row');
    if (row) {
      const id = row.dataset.id;
      expandedId = expandedId === id ? null : id;
      render();
    }
  });

  // FAB
  fabEl.addEventListener('click', function() {
    openAddModal();
  });

  // Modal cancel
  btnCancel.addEventListener('click', closeModal);
  overlayEl.addEventListener('click', function(e) {
    if (e.target === overlayEl) closeModal();
  });

  // Modal save
  btnSave.addEventListener('click', function() {
    const name = nameInput.value.trim();
    const room = roomInput.value;
    const num = parseInt(freqNumber.value, 10);
    const unitDays = parseInt(freqUnit.value, 10);
    if (!name || !num || num < 1) return;

    const intervalDays = num * unitDays;

    if (editingId) {
      const chore = chores.find(c => c.id === editingId);
      if (chore) {
        chore.name = name;
        chore.room = room;
        chore.intervalDays = intervalDays;
      }
    } else {
      chores.push({
        id: generateId(),
        name: name,
        room: room,
        intervalDays: intervalDays,
        completions: [],
        createdAt: new Date().toISOString()
      });
    }

    saveChores(chores);
    closeModal();
    render();
  });

  // Enable save when name is not empty
  nameInput.addEventListener('input', function() {
    btnSave.disabled = !nameInput.value.trim();
  });

  // --- Actions ---
  function markDone(id) {
    const chore = chores.find(c => c.id === id);
    if (!chore) return;
    if (!chore.completions) chore.completions = [];
    chore.completions.unshift(new Date().toISOString());
    saveChores(chores);
    // Delay render so animation plays before card moves
    setTimeout(render, 350);
  }

  function deleteCompletion(choreId, index) {
    const chore = chores.find(c => c.id === choreId);
    if (!chore || !chore.completions) return;
    chore.completions.splice(index, 1);
    saveChores(chores);
    render();
  }

  function deleteChore(id) {
    chores = chores.filter(c => c.id !== id);
    expandedId = null;
    saveChores(chores);
    render();
  }

  function openAddModal() {
    editingId = null;
    modalTitleEl.textContent = 'Add Chore';
    nameInput.value = '';
    roomInput.value = '';
    freqNumber.value = '1';
    freqUnit.value = '7';
    btnSave.disabled = true;
    btnSave.textContent = 'Add';
    overlayEl.classList.add('open');
    setTimeout(() => nameInput.focus(), 100);
  }

  function openEditModal(id) {
    const chore = chores.find(c => c.id === id);
    if (!chore) return;
    editingId = id;
    modalTitleEl.textContent = 'Edit Chore';
    nameInput.value = chore.name;
    roomInput.value = chore.room || '';
    btnSave.disabled = false;
    btnSave.textContent = 'Save';

    // Decompose intervalDays back to number + unit
    const days = chore.intervalDays;
    if (days % 30 === 0 && days >= 30) {
      freqNumber.value = days / 30;
      freqUnit.value = '30';
    } else if (days % 7 === 0 && days >= 7) {
      freqNumber.value = days / 7;
      freqUnit.value = '7';
    } else {
      freqNumber.value = days;
      freqUnit.value = '1';
    }

    overlayEl.classList.add('open');
    setTimeout(() => nameInput.focus(), 100);
  }

  function closeModal() {
    overlayEl.classList.remove('open');
    editingId = null;
  }

  // Handle Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && overlayEl.classList.contains('open')) {
      closeModal();
    }
  });

  // --- Init ---
  render();
})();
</script>
</body>
</html>
